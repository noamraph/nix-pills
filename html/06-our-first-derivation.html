<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Our First Derivation - Nix Pills</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="00-preface.html">Preface</a></li><li class="chapter-item expanded "><a href="01-why-you-should-give-it-try.html"><strong aria-hidden="true">1.</strong> Why You Should Give it a Try</a></li><li class="chapter-item expanded "><a href="02-install-on-your-running.html"><strong aria-hidden="true">2.</strong> Install on Your Running System</a></li><li class="chapter-item expanded "><a href="03-enter-environment.html"><strong aria-hidden="true">3.</strong> Enter the Environment</a></li><li class="chapter-item expanded "><a href="04-basics-of-language.html"><strong aria-hidden="true">4.</strong> The Basics of the Language</a></li><li class="chapter-item expanded "><a href="05-functions-and-imports.html"><strong aria-hidden="true">5.</strong> Functions and Imports</a></li><li class="chapter-item expanded "><a href="06-our-first-derivation.html" class="active"><strong aria-hidden="true">6.</strong> Our First Derivation</a></li><li class="chapter-item expanded "><a href="07-working-derivation.html"><strong aria-hidden="true">7.</strong> Working Derivation</a></li><li class="chapter-item expanded "><a href="08-generic-builders.html"><strong aria-hidden="true">8.</strong> Generic Builders</a></li><li class="chapter-item expanded "><a href="09-automatic-runtime.html"><strong aria-hidden="true">9.</strong> Automatic Runtime Dependencies</a></li><li class="chapter-item expanded "><a href="10-developing-with-nix-shell.html"><strong aria-hidden="true">10.</strong> Developing with nix-shell</a></li><li class="chapter-item expanded "><a href="11-garbage-collector.html"><strong aria-hidden="true">11.</strong> The Garbage Collector</a></li><li class="chapter-item expanded "><a href="12-inputs-design-pattern.html"><strong aria-hidden="true">12.</strong> Package Repositories and the Inputs Design Pattern</a></li><li class="chapter-item expanded "><a href="13-callpackage-design-pattern.html"><strong aria-hidden="true">13.</strong> Callpackage Design Pattern</a></li><li class="chapter-item expanded "><a href="14-override-design-pattern.html"><strong aria-hidden="true">14.</strong> Override Design Pattern</a></li><li class="chapter-item expanded "><a href="15-nix-search-paths.html"><strong aria-hidden="true">15.</strong> Nix Search Paths</a></li><li class="chapter-item expanded "><a href="16-nixpkgs-parameters.html"><strong aria-hidden="true">16.</strong> Nixpkgs Parameters</a></li><li class="chapter-item expanded "><a href="17-nixpkgs-overriding-packages.html"><strong aria-hidden="true">17.</strong> Nixpkgs Overriding Packages</a></li><li class="chapter-item expanded "><a href="18-nix-store-paths.html"><strong aria-hidden="true">18.</strong> Nix Store Paths</a></li><li class="chapter-item expanded "><a href="19-fundamentals-of-stdenv.html"><strong aria-hidden="true">19.</strong> Fundamentals of Stdenv</a></li><li class="chapter-item expanded "><a href="20-basic-dependencies-and-hooks.html"><strong aria-hidden="true">20.</strong> Basic Dependencies and Hooks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix Pills</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="our-first-derivation"><a class="header" href="#our-first-derivation">Our First Derivation</a></h1>
<p>Welcome to the sixth Nix pill. In the previous <a href="05-functions-and-imports.html">fifth
pill</a> we introduced functions and imports.
Functions and imports are very simple concepts that allow for building
complex abstractions and composition of modules to build a flexible Nix
system.</p>
<p>In this post we finally arrived to writing a derivation. Derivations are
the building blocks of a Nix system, from a file system view point. The
Nix language is used to describe such derivations.</p>
<p>I remind you how to enter the Nix environment:
<code>source ~/.nix-profile/etc/profile.d/nix.sh</code></p>
<h2 id="the-derivation-function"><a class="header" href="#the-derivation-function">The derivation function</a></h2>
<p>The <a href="https://nixos.org/manual/nix/stable/expressions/derivations.html">derivation built-in
function</a>
is used to create derivations. I invite you to read the link in the Nix
manual about the derivation built-in. A derivation from a Nix language
view point is simply a set, with some attributes. Therefore you can pass
the derivation around with variables like anything else.</p>
<p>That's where the real power comes in.</p>
<p>The <code>derivation</code> function receives a set as its first argument. This set
requires at least the following three attributes:</p>
<ul>
<li>
<p>name: the name of the derivation. In the nix store the format is
hash-name, that's the name.</p>
</li>
<li>
<p>system: is the name of the system in which the derivation can be
built. For example, x86_64-linux.</p>
</li>
<li>
<p>builder: is the binary program that builds the derivation.</p>
</li>
</ul>
<p>First of all, what's the name of our system as seen by nix?</p>
<pre><code>nix-repl&gt; builtins.currentSystem
"x86_64-linux"
</code></pre>
<p>Let's try to fake the name of the system:</p>
<pre><code>nix-repl&gt; d = derivation { name = "myname"; builder = "mybuilder"; system = "mysystem"; }
nix-repl&gt; d
«derivation /nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv»
</code></pre>
<p>Oh oh, what's that? Did it build the derivation? No it didn't, but it
<strong>did create the .drv file</strong>. <code>nix repl</code> does not build derivations
unless you tell it to do so.</p>
<h2 id="digression-about-drv-files"><a class="header" href="#digression-about-drv-files">Digression about .drv files</a></h2>
<p>What's that <code>.drv</code> file? It is the specification of how to build the
derivation, without all the Nix language fuzz.</p>
<p>Before continuing, some analogies with the C language:</p>
<ul>
<li>
<p><code>.nix</code> files are like <code>.c</code> files.</p>
</li>
<li>
<p><code>.drv</code> files are intermediate files like <code>.o</code> files. The <code>.drv</code>
describes how to build a derivation; it's the bare minimum
information.</p>
</li>
<li>
<p>out paths are then the product of the build.</p>
</li>
</ul>
<p>Both drv paths and out paths are stored in the nix store as you can see.</p>
<p>What's in that <code>.drv</code> file? You can read it, but it's better to pretty
print it:</p>
<div class="info">
Note: If your version of nix doesn't have `nix derivation show`, use
`nix show-derivation` instead.
</div>
<pre><code>$ nix derivation show /nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv
{
  "/nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv": {
    "outputs": {
      "out": {
        "path": "/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname"
      }
    },
    "inputSrcs": [],
    "inputDrvs": {},
    "platform": "mysystem",
    "builder": "mybuilder",
    "args": [],
    "env": {
      "builder": "mybuilder",
      "name": "myname",
      "out": "/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname",
      "system": "mysystem"
    }
  }
}
</code></pre>
<p>Ok, we can see there's an out path, but it does not exist yet. We never
told Nix to build it, but we know beforehand where the build output will
be. Why?</p>
<p>Think, if Nix ever built the derivation just because we accessed it in
Nix, we would have to wait a long time if it was, say, Firefox. That's
why Nix let us know the path beforehand and kept evaluating the Nix
expressions, but it's still empty because no build was ever made.</p>
<p>Important: the hash of the out path is based solely on the
input derivations in the current version of Nix, not on the contents of
the build product. It's possible however to have
<a href="https://en.wikipedia.org/wiki/Content-addressable_storage">content-addressable</a>
derivations for e.g. tarballs as we'll see later on.</p>
<p>Many things are empty in that <code>.drv</code>, however I'll write a summary of
the <a href="http://nixos.org/~eelco/pubs/phd-thesis.pdf">.drv format</a> for you:</p>
<ol>
<li>
<p>The output paths (there can be multiple ones). By default nix
creates one out path called "out".</p>
</li>
<li>
<p>The list of input derivations. It's empty because we are not
referring to any other derivation. Otherwise, there would be a list
of other .drv files.</p>
</li>
<li>
<p>The system and the builder executable (yes, it's a fake one).</p>
</li>
<li>
<p>Then a list of environment variables passed to the builder.</p>
</li>
</ol>
<p>That's it, the minimum necessary information to build our derivation.</p>
<p>Important note: the environment variables passed to the
builder are just those you see in the .drv plus some other Nix related
configuration (number of cores, temp dir, ...). The builder will not
inherit any variable from your running shell, otherwise builds would
suffer from
<a href="https://wiki.debian.org/ReproducibleBuilds">non-determinism</a>.</p>
<p>Back to our fake derivation.</p>
<p>Let's build our really fake derivation:</p>
<pre><code>nix-repl&gt; d = derivation { name = "myname"; builder = "mybuilder"; system = "mysystem"; }
nix-repl&gt; :b d
[...]
these derivations will be built:
  /nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv
building path(s) `/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname'
error: a `mysystem' is required to build `/nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv', but I am a `x86_64-linux'
</code></pre>
<p>The <code>:b</code> is a <code>nix repl</code> specific command to build a derivation. You can
see more commands with <code>:?</code> . So in the output you can see that it takes
the <code>.drv</code> as information on how to build the derivation. Then it says
it's trying to produce our out path. Finally the error we were waiting
for: that derivation can't be built on our system.</p>
<p>We're doing the build inside <code>nix repl</code>, but what if we don't want to
use <code>nix repl</code>? You can <strong>realise</strong> a <code>.drv</code> with:</p>
<pre><code>$ nix-store -r /nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv
</code></pre>
<p>You will get the same output as before.</p>
<p>Let's fix the system attribute:</p>
<pre><code>nix-repl&gt; d = derivation { name = "myname"; builder = "mybuilder"; system = builtins.currentSystem; }
nix-repl&gt; :b d
[...]
build error: invalid file name `mybuilder'
</code></pre>
<p>A step forward: of course, that <code>mybuilder</code> executable does not really
exist. Stop for a moment.</p>
<h2 id="whats-in-a-derivation-set"><a class="header" href="#whats-in-a-derivation-set">What's in a derivation set</a></h2>
<p>It is useful to start by inspecting the return value from the derivation
function. In this case, the returned value is a plain set:</p>
<pre><code>nix-repl&gt; d = derivation { name = "myname"; builder = "mybuilder"; system = "mysystem"; }
nix-repl&gt; builtins.isAttrs d
true
nix-repl&gt; builtins.attrNames d
[ "all" "builder" "drvAttrs" "drvPath" "name" "out" "outPath" "outputName" "system" "type" ]
</code></pre>
<p>You can guess what <code>builtins.isAttrs</code> does; it returns true if the
argument is a set. While <code>builtins.attrNames</code> returns a list of keys of
the given set. Some kind of reflection, you might say.</p>
<p>Start from drvAttrs:</p>
<pre><code>nix-repl&gt; d.drvAttrs
{ builder = "mybuilder"; name = "myname"; system = "mysystem"; }
</code></pre>
<p>That's basically the input we gave to the derivation function. Also the
<code>d.name</code>, <code>d.system</code> and <code>d.builder</code> attributes are exactly the ones we
gave as input.</p>
<pre><code>nix-repl&gt; (d == d.out)
true
</code></pre>
<p>So out is just the derivation itself, it seems weird but the reason is
that we only have one output from the derivation. That's also the
reason why <code>d.all</code> is a singleton. We'll see multiple outputs later.</p>
<p>The <code>d.drvPath</code> is the path of the <code>.drv</code> file:
<code>/nix/store/z3hhlxbckx4g3n9sw91nnvlkjvyw754p-myname.drv</code>.</p>
<p>Something interesting is the <code>type</code> attribute. It's <code>"derivation"</code>. Nix
does add a little of magic to sets with type derivation, but not that
much. To help you understand, you can create yourself a set with that
type, it's a simple set:</p>
<pre><code>nix-repl&gt; { type = "derivation"; }
«derivation ???»
</code></pre>
<p>Of course it has no other information, so Nix doesn't know what to say
:-) But you get it, the <code>type = "derivation"</code> is just a convention for
Nix and for us to understand the set is a derivation.</p>
<p>When writing packages, we are interested in the outputs. The other
metadata is needed for Nix to know how to create the drv path and the
out path.</p>
<p>The <code>outPath</code> attribute is the build path in the nix store:
<code>/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname</code>.</p>
<h2 id="referring-to-other-derivations"><a class="header" href="#referring-to-other-derivations">Referring to other derivations</a></h2>
<p>Just like dependencies in other package managers, how do we refer to
other packages? How do we refer to other derivations in terms of files
on the disk? We use the <code>outPath</code>. The <code>outPath</code> describes the location
of the files of that derivation. To make it more convenient, Nix is able
to do a conversion from a derivation set to a string.</p>
<pre><code>nix-repl&gt; d.outPath
"/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname"
nix-repl&gt; builtins.toString d
"/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname"
</code></pre>
<p>Nix does the "set to string conversion" as long as there is the
<code>outPath</code> attribute (much like a toString method in other languages):</p>
<pre><code>nix-repl&gt; builtins.toString { outPath = "foo"; }
"foo"
nix-repl&gt; builtins.toString { a = "b"; }
error: cannot coerce a set to a string, at (string):1:1
</code></pre>
<p>Say we want to use binaries from coreutils (ignore the nixpkgs etc.):</p>
<pre><code>nix-repl&gt; :l &lt;nixpkgs&gt;
Added 3950 variables.
nix-repl&gt; coreutils
«derivation /nix/store/1zcs1y4n27lqs0gw4v038i303pb89rw6-coreutils-8.21.drv»
nix-repl&gt; builtins.toString coreutils
"/nix/store/8w4cbiy7wqvaqsnsnb3zvabq1cp2zhyz-coreutils-8.21"
</code></pre>
<p>Apart from the nixpkgs stuff, just think we added to the scope a series
of variables. One of them is coreutils. It is the derivation of the
coreutils package you all know of from other Linux distributions. It
contains basic binaries for GNU/Linux systems (you may have multiple
derivations of coreutils in the nix store, no worries):</p>
<pre><code>$ ls /nix/store/*coreutils*/bin
[...]
</code></pre>
<p>I remind you, inside strings it's possible to interpolate Nix
expressions with <code>${...}</code>:</p>
<pre><code>nix-repl&gt; "${d}"
"/nix/store/40s0qmrfb45vlh6610rk29ym318dswdr-myname"
nix-repl&gt; "${coreutils}"
"/nix/store/8w4cbiy7wqvaqsnsnb3zvabq1cp2zhyz-coreutils-8.21"
</code></pre>
<p>That's very convenient, because then we could refer to e.g. the
bin/true binary like this:</p>
<pre><code>nix-repl&gt; "${coreutils}/bin/true"
"/nix/store/8w4cbiy7wqvaqsnsnb3zvabq1cp2zhyz-coreutils-8.21/bin/true"
</code></pre>
<h2 id="an-almost-working-derivation"><a class="header" href="#an-almost-working-derivation">An almost working derivation</a></h2>
<p>In the previous attempt we used a fake builder, <code>mybuilder</code> which
obviously does not exist. But we can use for example bin/true, which
always exits with 0 (success).</p>
<pre><code>nix-repl&gt; :l &lt;nixpkgs&gt;
nix-repl&gt; d = derivation { name = "myname"; builder = "${coreutils}/bin/true"; system = builtins.currentSystem; }
nix-repl&gt; :b d
[...]
builder for `/nix/store/qyfrcd53wmc0v22ymhhd5r6sz5xmdc8a-myname.drv' failed to produce output path `/nix/store/ly2k1vswbfmswr33hw0kf0ccilrpisnk-myname'
</code></pre>
<p>Another step forward, it executed the builder (bin/true), but the
builder did not create the out path of course, it just exited with 0.</p>
<p>Obvious note: every time we change the derivation, a new
hash is created.</p>
<p>Let's examine the new <code>.drv</code> now that we referred to another
derivation:</p>
<pre><code>$ nix derivation show /nix/store/qyfrcd53wmc0v22ymhhd5r6sz5xmdc8a-myname.drv
{
  "/nix/store/qyfrcd53wmc0v22ymhhd5r6sz5xmdc8a-myname.drv": {
    "outputs": {
      "out": {
        "path": "/nix/store/ly2k1vswbfmswr33hw0kf0ccilrpisnk-myname"
      }
    },
    "inputSrcs": [],
    "inputDrvs": {
      "/nix/store/hixdnzz2wp75x1jy65cysq06yl74vx7q-coreutils-8.29.drv": [
        "out"
      ]
    },
    "platform": "x86_64-linux",
    "builder": "/nix/store/qrxs7sabhqcr3j9ai0j0cp58zfnny0jz-coreutils-8.29/bin/true",
    "args": [],
    "env": {
      "builder": "/nix/store/qrxs7sabhqcr3j9ai0j0cp58zfnny0jz-coreutils-8.29/bin/true",
      "name": "myname",
      "out": "/nix/store/ly2k1vswbfmswr33hw0kf0ccilrpisnk-myname",
      "system": "x86_64-linux"
    }
  }
}
</code></pre>
<p>Aha! Nix added a dependency to our myname.drv, it's the coreutils.drv.
Before doing our build, Nix should build the coreutils.drv. But since
coreutils is already in our nix store, no build is needed, it's already
there with out path
<code>/nix/store/qrxs7sabhqcr3j9ai0j0cp58zfnny0jz-coreutils-8.29</code>.</p>
<h2 id="when-is-the-derivation-built"><a class="header" href="#when-is-the-derivation-built">When is the derivation built</a></h2>
<p>Nix does not build derivations <strong>during evaluation</strong> of Nix expressions.
In fact, that's why we have to do ":b drv" in <code>nix repl</code>, or use
nix-store -r in the first place.</p>
<p>An important separation is made in Nix:</p>
<ul>
<li>
<p><strong>Instantiate/Evaluation time</strong>: the Nix expression is parsed,
interpreted and finally returns a derivation set. During evaluation,
you can refer to other derivations because Nix will create .drv
files and we will know out paths beforehand. This is achieved with
<a href="https://nixos.org/manual/nix/stable/command-ref/nix-instantiate.html">nix-instantiate</a>.</p>
</li>
<li>
<p><strong>Realise/Build time</strong>: the .drv from the derivation set is built,
first building .drv inputs (build dependencies). This is achieved
with <a href="https://nixos.org/manual/nix/stable/command-ref/nix-store.html#operation---realise">nix-store
-r</a>.</p>
</li>
</ul>
<p>Think of it as of compile time and link time like with C/C++ projects.
You first compile all source files to object files. Then link object
files in a single executable.</p>
<p>In Nix, first the Nix expression (usually in a .nix file) is compiled to
.drv, then each .drv is built and the product is installed in the
relative out paths.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Is it that complicated to create a package for Nix? No, it's not.</p>
<p>We're walking through the fundamentals of Nix derivations, to
understand how they work, how they are represented. Packaging in Nix is
certainly easier than that, but we're not there yet in this post. More
Nix pills are needed.</p>
<p>With the derivation function we provide a set of information on how to
build a package, and we get back the information about where the package
was built. Nix converts a set to a string when there's an <code>outPath</code>;
that's very convenient. With that, it's easy to refer to other
derivations.</p>
<p>When Nix builds a derivation, it first creates a .drv file from a
derivation expression, and uses it to build the output. It does so
recursively for all the dependencies (inputs). It "executes" the .drv
files like a machine. Not much magic after all.</p>
<h2 id="next-pill"><a class="header" href="#next-pill">Next pill</a></h2>
<p>...we will finally write our first <strong>working</strong> derivation. Yes, this
post is about "our first derivation", but I never said it was a
working one ;)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="05-functions-and-imports.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="07-working-derivation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="05-functions-and-imports.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="07-working-derivation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
