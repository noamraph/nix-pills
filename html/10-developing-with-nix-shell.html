<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Developing with nix-shell - Nix Pills</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="00-preface.html">Preface</a></li><li class="chapter-item expanded "><a href="01-why-you-should-give-it-try.html"><strong aria-hidden="true">1.</strong> Why You Should Give it a Try</a></li><li class="chapter-item expanded "><a href="02-install-on-your-running.html"><strong aria-hidden="true">2.</strong> Install on Your Running System</a></li><li class="chapter-item expanded "><a href="03-enter-environment.html"><strong aria-hidden="true">3.</strong> Enter the Environment</a></li><li class="chapter-item expanded "><a href="04-basics-of-language.html"><strong aria-hidden="true">4.</strong> The Basics of the Language</a></li><li class="chapter-item expanded "><a href="05-functions-and-imports.html"><strong aria-hidden="true">5.</strong> Functions and Imports</a></li><li class="chapter-item expanded "><a href="06-our-first-derivation.html"><strong aria-hidden="true">6.</strong> Our First Derivation</a></li><li class="chapter-item expanded "><a href="07-working-derivation.html"><strong aria-hidden="true">7.</strong> Working Derivation</a></li><li class="chapter-item expanded "><a href="08-generic-builders.html"><strong aria-hidden="true">8.</strong> Generic Builders</a></li><li class="chapter-item expanded "><a href="09-automatic-runtime.html"><strong aria-hidden="true">9.</strong> Automatic Runtime Dependencies</a></li><li class="chapter-item expanded "><a href="10-developing-with-nix-shell.html" class="active"><strong aria-hidden="true">10.</strong> Developing with nix-shell</a></li><li class="chapter-item expanded "><a href="11-garbage-collector.html"><strong aria-hidden="true">11.</strong> The Garbage Collector</a></li><li class="chapter-item expanded "><a href="12-inputs-design-pattern.html"><strong aria-hidden="true">12.</strong> Package Repositories and the Inputs Design Pattern</a></li><li class="chapter-item expanded "><a href="13-callpackage-design-pattern.html"><strong aria-hidden="true">13.</strong> Callpackage Design Pattern</a></li><li class="chapter-item expanded "><a href="14-override-design-pattern.html"><strong aria-hidden="true">14.</strong> Override Design Pattern</a></li><li class="chapter-item expanded "><a href="15-nix-search-paths.html"><strong aria-hidden="true">15.</strong> Nix Search Paths</a></li><li class="chapter-item expanded "><a href="16-nixpkgs-parameters.html"><strong aria-hidden="true">16.</strong> Nixpkgs Parameters</a></li><li class="chapter-item expanded "><a href="17-nixpkgs-overriding-packages.html"><strong aria-hidden="true">17.</strong> Nixpkgs Overriding Packages</a></li><li class="chapter-item expanded "><a href="18-nix-store-paths.html"><strong aria-hidden="true">18.</strong> Nix Store Paths</a></li><li class="chapter-item expanded "><a href="19-fundamentals-of-stdenv.html"><strong aria-hidden="true">19.</strong> Fundamentals of Stdenv</a></li><li class="chapter-item expanded "><a href="20-basic-dependencies-and-hooks.html"><strong aria-hidden="true">20.</strong> Basic Dependencies and Hooks</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Nix Pills</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="developing-with-nix-shell"><a class="header" href="#developing-with-nix-shell">Developing with <code>nix-shell</code></a></h1>
<p>Welcome to the 10th Nix pill. In the previous <a href="09-automatic-runtime.html">9th
pill</a> we saw one of the powerful
features of Nix: automatic discovery of runtime dependencies. We also
finalized the GNU <code>hello</code> package.</p>
<p>In this pill, we will introduce the <code>nix-shell</code> tool and use it to hack
on the GNU <code>hello</code> program. We will see how <code>nix-shell</code> gives us an
isolated environment while we modify the source files of the project,
similar to how <code>nix-build</code> gave us an isolated environment while
building the derivation.</p>
<p>Finally, we will modify our builder to work more ergonomically with a
<code>nix-shell</code>-focused workflow.</p>
<h2 id="what-is-nix-shell"><a class="header" href="#what-is-nix-shell">What is <code>nix-shell</code>?</a></h2>
<p>The
<a href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html">nix-shell</a>
tool drops us in a shell after setting up the environment variables
necessary to hack on a derivation. It does not build the derivation; it
only serves as a preparation so that we can run the build steps
manually.</p>
<p>Recall that in a nix environment, we don't have access to libraries or
programs unless they have been installed with <code>nix-env</code>. However,
installing libraries with <code>nix-env</code> is not good practice. We prefer to
have isolated environments for development, which <code>nix-shell</code> provides
for us.</p>
<p>We can call <code>nix-shell</code> on any Nix expression which returns a
derivation, but the resulting <code>bash</code> shell's <code>PATH</code> does not have the
utilities we want:</p>
<pre><code>$ nix-shell hello.nix
[nix-shell]$ make
bash: make: command not found
[nix-shell]$ echo $baseInputs
/nix/store/jff4a6zqi0yrladx3kwy4v6844s3swpc-gnutar-1.27.1 [...]
</code></pre>
<p>This shell is rather useless. It would be reasonable to expect that the
GNU <code>hello</code> build inputs are available in <code>PATH</code>, including GNU <code>make</code>,
but this is not the case.</p>
<p>However, we do have the environment variables that we set in the
derivation, like <code>$baseInputs</code>, <code>$buildInputs</code>, <code>$src</code>, and so on.</p>
<p>This means that we can <code>source</code> our <code>builder.sh</code>, and it will build the
derivation. You may get an error in the installation phase, because your
user may not have the permission to write to <code>/nix/store</code>:</p>
<pre><code>[nix-shell]$ source builder.sh
...
</code></pre>
<p>The derivation didn't install, but it did build. Note the following:</p>
<ul>
<li>
<p>We sourced <code>builder.sh</code> and it ran all of the build steps, including
setting up the <code>PATH</code> for us.</p>
</li>
<li>
<p>The working directory is no longer a temp directory created by
<code>nix-build</code>, but is instead the directory in which we entered the
shell. Therefore, <code>hello-2.10</code> has been unpacked in the current
directory.</p>
</li>
</ul>
<p>We are able to <code>cd</code> into <code>hello-2.10</code> and type <code>make</code>, because <code>make</code> is
now available.</p>
<p>The take-away is that <code>nix-shell</code> drops us in a shell with the same (or
very similar) environment used to run the builder.</p>
<h2 id="a-builder-for-nix-shell"><a class="header" href="#a-builder-for-nix-shell">A builder for nix-shell</a></h2>
<p>The previous steps require some manual commands to be run and are not
optimized for a workflow centered on <code>nix-shell</code>. We will now improve
our builder to be more <code>nix-shell</code> friendly.</p>
<p>There are a few things that we would like to change.</p>
<p>First, when we <code>source</code>d the <code>builder.sh</code> file, we obtained the file in
the current directory. What we really wanted was the <code>builder.sh</code> that
is stored in the nix store, as this is the file that would be used by
<code>nix-build</code>. To achieve this, the correct technique is to pass an
environment variable through the derivation. (Note that <code>$builder</code> is
already defined, but it points to the bash executable rather than our
<code>builder.sh</code>. Our <code>builder.sh</code> is passed as an argument to bash.)</p>
<p>Second, we don't want to run the whole builder: we only want to setup
the necessary environment for manually building the project. Thus, we
can break <code>builder.sh</code> into two files: a <code>setup.sh</code> for setting up the
environment, and the real <code>builder.sh</code> that <code>nix-build</code> expects.</p>
<p>During our refactoring, we will wrap the build phases in functions to
give more structure to our design. Additionally, we'll move the
<code>set -e</code> to the builder file instead of the setup file. The <code>set -e</code> is
annoying in <code>nix-shell</code>, as it will terminate the shell if an error is
encountered (such as a mistyped command.)</p>
<p>Here is our modified <code>autotools.nix</code>. Noteworthy is the
<code>setup = ./setup.sh;</code> attribute in the derivation, which adds <code>setup.sh</code>
to the nix store and correspondingly adds a <code>$setup</code> environment
variable in the builder.</p>
<pre><code>pkgs: attrs:
let
  defaultAttrs = {
    builder = "${pkgs.bash}/bin/bash";
    args = [ ./builder.sh ];
    setup = ./setup.sh;
    baseInputs = with pkgs; [
      gnutar
      gzip
      gnumake
      gcc
      coreutils
      gawk
      gnused
      gnugrep
      binutils.bintools
      patchelf
      findutils
    ];
    buildInputs = [ ];
    system = builtins.currentSystem;
  };
in
derivation (defaultAttrs // attrs)
</code></pre>
<p>Thanks to that, we can split <code>builder.sh</code> into <code>setup.sh</code> and
<code>builder.sh</code>. What <code>builder.sh</code> does is <code>source</code> <code>$setup</code> and call the
<code>genericBuild</code> function. Everything else is just some changes to the
bash script.</p>
<p>Here is the modified <code>builder.sh</code>:</p>
<pre><code>set -e
source $setup
genericBuild
</code></pre>
<p>Here is the newly added <code>setup.sh</code>:</p>
<pre><code>unset PATH
for p in $baseInputs $buildInputs; do
  export PATH=$p/bin${PATH:+:}$PATH
done

function unpackPhase() {
  tar -xzf $src

  for d in *; do
    if [ -d "$d" ]; then
      cd "$d"
      break
    fi
  done
}

function configurePhase() {
  ./configure --prefix=$out
}

function buildPhase() {
  make
}

function installPhase() {
  make install
}

function fixupPhase() {
  find $out -type f -exec patchelf --shrink-rpath '{}' \; -exec strip '{}' \; 2&gt;/dev/null
}

function genericBuild() {
  unpackPhase
  configurePhase
  buildPhase
  installPhase
  fixupPhase
}
</code></pre>
<p>Finally, here is <code>hello.nix</code>:</p>
<pre><code>let
  pkgs = import &lt;nixpkgs&gt; { };
  mkDerivation = import ./autotools.nix pkgs;
in
mkDerivation {
  name = "hello";
  src = ./hello-2.12.1.tar.gz;
}
</code></pre>
<p>Now back to nix-shell:</p>
<pre><code>$ nix-shell hello.nix
[nix-shell]$ source $setup
[nix-shell]$
</code></pre>
<p>Now, for example, you can run <code>unpackPhase</code> which unpacks <code>$src</code> and
enters the directory. And you can run commands like <code>./configure</code>,
<code>make</code>, and so forth manually, or run phases with their respective
functions.</p>
<p>The process is that straightforward. <code>nix-shell</code> builds the <code>.drv</code> file
and its input dependencies, then drops into a shell by setting up the
environment variables necessary to build the <code>.drv</code>. In particular, the
environment variables in the shell match those passed to the
<code>derivation</code> function.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>With <code>nix-shell</code> we are able to drop into an isolated environment
suitable for developing a project. This environment provides the
necessary dependencies for the development shell, similar to how
<code>nix-build</code> provides the necessary dependencies to a builder.
Additionally, we can build and debug the project manually, executing
step-by-step like we would in any other operating system. Note that we
never installed tools such <code>gcc</code> or <code>make</code> system-wide; these tools and
libraries are isolated and available per-build.</p>
<h2 id="next-pill"><a class="header" href="#next-pill">Next pill</a></h2>
<p>In the next pill, we will clean up the nix store. We have written and
built derivations which add to the nix store, but until now we haven't
worried about cleaning up the used space in the store.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="09-automatic-runtime.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="11-garbage-collector.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="09-automatic-runtime.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="11-garbage-collector.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
